// Each #kernel tells which function to compile; you can have many kernels
#pragma kernel CSMain

// Create a RenderTexture with enableRandomWrite flag and set it
// with cs.SetTexture
RWTexture2D<float4> Result;

struct Layer {
    int NodeIn;
    int NodeOut;
};

StructuredBuffer<Layer> layers;
StructuredBuffer<float> Weights;
StructuredBuffer<float> Biases;
int numLayers;

float4 CalcOutputs(float4 inputs) {
    int counter = 0;
    int wCounter = 0;
    for (int i = 0; i < numLayers; i++)
    {
        float4 outputs = float4(0,0,0,0);
        [unroll(2)] for (int j = 0; j < layers[i].NodeOut; j++)
        {
            float output = Biases[counter];
            for (int k = 0; k < layers[i].NodeIn; k++)
            {
                output += inputs[j] * Weights[wCounter];
                wCounter++;
            }
            outputs[j] = output;
            counter++;
        }
        inputs = outputs;
    }
    return inputs;
}

float4 Classify(float4 inputs) {
    float4 output = CalcOutputs(inputs);
    if (output[0] >= output[1]) {
        return float4(1,0,0,150.0/255.0);
    }
    else {
        return float4(0, 1, 0, 150.0 / 255.0);
    }
}

[numthreads(8,8,1)]
void CSMain (uint3 id : SV_DispatchThreadID)
{
    Result[id.xy] = Classify(float4(id.x/64.0,id.y/64.0, 0, 0));
}